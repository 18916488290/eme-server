<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:include="fragments/map-layout :: headFragment">
</head>
<body>
	<!-- HEADER -->
	<header class="navbar clearfix navbar-fixed-top" id="header"
		th:include="fragments/map-layout :: headerFragment"> </header>
	<!--/HEADER -->

	<!-- PAGE -->
	<section id="page">
		<!-- SIDEBAR -->
		<div id="sidebar" class="sidebar"
			th:include="fragments/map-layout :: sidebarFragment"></div>
		<!-- /SIDEBAR -->
		<!-- maincontent -->
		<div id="main-content"
			th:include="fragments/map-layout :: main-contentFragment">
			<!-- BREADCRUMBS -->
			<ul class="breadcrumb" id="BREADCRUMBS">
				<li><i class="fa fa-home"></i> <a href="index.html"  th:href="@{/}">主界面</a></li>
				<li><a href="#"  th:href="@{/mapRiskSource}">风险源分布专题</a></li>
			</ul>
			<!-- /BREADCRUMBS -->

			<!-- mainContentBox -->
			<div id="mainContentBox">
				  <div class="gmaps" id="baidumap"></div>  
	              <div id="w" class="easyui-window" title="风险源信息" data-options="left:800,top:254,minimizable:false">
				  <div class="easyui-panel" title="" style="width:440px;">
										<table cellpadding="0" cellspacing="0" border="0" class="datatable table table-striped table-bordered table-hover">
											<thead>
												<tr>
													<th>风险源</th>
													<th>行政区域</th>
													<th>操作</th>
												</tr>
											</thead>
											<tbody>
												<tr  th:each="nc : ${riskSources}">
													<td th:text="${nc.riskName}">企业名称</td>
													<td th:text="${nc.company.administrativeDivision.division}">行政区域</td>								
													<td>
													<a href="#" th:href="@{/riskSourceInfo(riskSourceId=${nc.id})}" target="_blank"><i class="fa  fa-file-text-o"></i><span>详细</span></a>
													<a th:href="'javascript:theLocation('+${nc.id}+','+${nc.lng} + ',' +${nc.lat} + ');'"><i class="fa  fa-map-marker"></i><span>定位</span></a>
													<a th:href="'javascript:localSearch('+${nc.id}+','+${nc.lng} + ',' +${nc.lat} + ',\'学校\');'"><i class="fa"></i><span>🏫学校</span></a>
													<a th:href="'javascript:localSearch('+${nc.id}+','+${nc.lng} + ',' +${nc.lat} + ',\'医院\');'"><i class="fa"></i><span>🏥医院</span></a>
													</td>
												</tr>
									
											</tbody>
											
										</table>
								
								</div>
						
							</div>	  
			</div>
			<!-- /mainContentBox -->
		
		</div>
		<!-- /maincontent -->
	</section>

    <div th:include="fragments/map-layout :: footerFragment"></div>
	<!--/PAGE -->
	<!-- JAVASCRIPTS -->
	<!-- Placed at the end of the document so the pages load faster -->
	<!-- JQUERY -->
	<div th:include="fragments/map-layout :: jsFragment"></div>
	<script>
		jQuery(document).ready(function() {		
		//	$('#w').window('collapse');
			App.setPage("mapRiskSource");  //Set current page 
			App.init(); //Initialise plugins and elements
		});
	</script>
	<script th:inline="javascript">
    /*<![CDATA[*/
               
    // var markers;
    // var baiduMarkers = new Array(); ;
               
    // 用经纬度设置地图中心点
	function theLocation(sourceId,lng,lat){
			var new_point = new BMap.Point(lng,lat);
			map.panTo(new_point);  
			map.setZoom(13);
			map.clearOverlays(); 
			addMapOverlay(sourceId);
			//map.openInfoWindow(infoWnd:InfoWindow, new_point);
	}

	// Local search
	function localSearch(sourceId,lng,lat,s){
			var new_point = new BMap.Point(lng,lat);
			map.panTo(new_point); 
			map.setZoom(13);
			map.clearOverlays(); 
			addMapOverlay(-1000);
			var circle = new BMap.Circle(new_point,5000,{fillColor:"blue", strokeWeight: 1 ,fillOpacity: 0.3, strokeOpacity: 0.3});
		    map.addOverlay(circle);
		    var local =  new BMap.LocalSearch(map, {renderOptions: {map: map, autoViewport: false}});  
		    local.searchNearby(s,new_point,5000);
	}
       
                   
    //创建和初始化地图函数：
    function initMap(){
      createMap();//创建地图
      add_control();
      setMapEvent();//设置地图事件
      addMapOverlay(-1000);//向地图添加覆盖物
	/*  map.setMapStyle(
		{styleJson:[
					  {"featureType":"water",
					   "elementType":"all",
					   "stylers":{ 
								 "color": "#674ea7"
								 }
					  }
					]
		});
      */
    }
    function createMap(){ 
      map = new BMap.Map("baidumap"); 
      $.getCenter(function(data){
         map.centerAndZoom(new BMap.Point(data.lng,data.lat),12);
      });
      
    }
    function setMapEvent(){
      map.enableDragging();
    }
 
    function addClickHandler(target,window){
        target.addEventListener("click",function(){
        window.open(target.getPosition());
      });
    }
	
	
	 function createInfoWindow(marker){
		 var content = '<fieldset> <div  class="panel">'+
							'<div title="" class="ddv panel-body panel-body-noheader panel-body-noborder" style="padding: 2px 0px; width: 100%;">'+
								'<style type="text/css">  .dv-table td{border:1px;text-align:center;padding:2px}.dv-label{font-weight:solid;color:#15428B;}</style>'+
								'<table cellpadding="0" cellspacing="0" border="0" class="datatable table table-striped table-bordered table-hover">'+
									'<tbody>'+
										'<tr>'+
											'<td class="dv-label">企业名称:</td>'+
											'<td>'+marker.riskSourceInfo.companyName+'</td>'+
											'<td class="dv-label">行政区域:</td>'+
											'<td>'+marker.riskSourceInfo.divsion+'</td>'+
										'</tr>'+
										'<tr>'+
											'<td class="dv-label">风险等级:</td>'+
											'<td>'+marker.riskSourceInfo.lvl+'</td>'+
											'<td class="dv-label">是否预案:</td>'+
											'<td>'+marker.riskSourceInfo.riskAversion+'</td>'+
										'</tr>'+
										'<tr>'+
											'<td class="dv-label">应急人员</td>'+
											'<td>'+marker.riskSourceInfo.emePersion+'</td>'+
											'<td class="dv-label">应急电话</td>'+
											'<td>'+marker.riskSourceInfo.emeTel+'</td>'+
										'</tr>'+
									'</tbody>'+
								'</table><a href="riskSourceInfo?riskSourceId='+marker.riskSourceInfo.companyId+'" target="_blank" style="width:120px">查看详细</a>'+
							'</div>'+
						'</div>'+
						'</fieldset>';
			var infoWindow = new BMapLib.SearchInfoWindow(map, content, {
				title: marker.title, //标题
				offset: new BMap.Size(0,7),
				width: 430,//宽度
				height: 140, //高度
				panel : "panel", //检索结果面板
				enableAutoPan : true, //自动平移
				searchTypes :[
				]
			});
		return infoWindow;
	 }
    function addMapOverlay(sourceId){
        $.getRiskSourcesMarkers(function(data){
                       var markers=data;
                         for(var index = 0; index < markers.length; index++ ){
                           var point = new BMap.Point(markers[index].point.lng,markers[index].point.lat);
                         //  var selectedmarker;
                           var marker;
                           if(sourceId==markers[index].riskSourceInfo.companyId)
                        	 {
                                marker = new BMap.Marker(point,{icon:new BMap.Icon("img/mapimg/waterstation-active.png",new BMap.Size(21,35),{
                                   imageOffset: new BMap.Size(markers[index].imageOffset.width,markers[index].imageOffset.height)
                                 })});
                                var selectedWin=createInfoWindow(markers[index]);
                                selectedWin.open(point);
                        	 }
                           else
                        	   { 
                        	   marker  = new BMap.Marker(point,{icon:new BMap.Icon("img/mapimg/waterstation.png",new BMap.Size(21,35),{
                                   imageOffset: new BMap.Size(markers[index].imageOffset.width,markers[index].imageOffset.height)
                               })});
                        	   
                        	   }
                           
             
                   		  var searchInfoWindow=createInfoWindow(markers[index]);
                           addClickHandler(marker,searchInfoWindow);
                           map.addOverlay(marker);
                         };
         });
         
    	

    }

	var top_left_control = new BMap.ScaleControl({anchor: BMAP_ANCHOR_TOP_LEFT});// 左上角，添加比例尺
	var top_left_navigation = new BMap.NavigationControl();  //左上角，添加默认缩放平移控件
	var mapType = new BMap.MapTypeControl({mapTypes: [BMAP_NORMAL_MAP,BMAP_HYBRID_MAP]});
	var overView = new BMap.OverviewMapControl();
	var overViewOpen = new BMap.OverviewMapControl({isOpen:true, anchor: BMAP_ANCHOR_BOTTOM_RIGHT});

	function add_control(){
		map.addControl(top_left_control);        
		map.addControl(top_left_navigation);  
		map.addControl(mapType);    
		map.addControl(overView);          //添加默认缩略地图控件
		map.addControl(overViewOpen);      //右下角，打开
	}
    //向地图添加控件
    var map;
    initMap();
   /*]]>*/
  </script>
	
	<!-- /JAVASCRIPTS -->
</body>
</html>