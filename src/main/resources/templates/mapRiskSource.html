<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:include="fragments/map-layout :: headFragment">
</head>
<body>
	<!-- HEADER -->
	<header class="navbar clearfix navbar-fixed-top" id="header"
		th:include="fragments/map-layout :: headerFragment"> </header>
	<!--/HEADER -->

	<!-- PAGE -->
	<section id="page">
		<!-- SIDEBAR -->
		<div id="sidebar" class="sidebar"
			th:include="fragments/map-layout :: sidebarFragment"></div>
		<!-- /SIDEBAR -->
		<!-- maincontent -->
		<div id="main-content"
			th:include="fragments/map-layout :: main-contentFragment">
			<!-- BREADCRUMBS -->
			<ul class="breadcrumb" id="BREADCRUMBS">
				<li><i class="fa fa-home"></i> <a href="index.html"  th:href="@{/}">ä¸»ç•Œé¢</a></li>
				<li><a href="#"  th:href="@{/mapRiskSource}">é£é™©æºåˆ†å¸ƒä¸“é¢˜</a></li>
			</ul>
			<!-- /BREADCRUMBS -->

			<!-- mainContentBox -->
			<div id="mainContentBox">
				  <div class="gmaps" id="baidumap"></div>  
	              <div id="w" class="easyui-window" title="é£é™©æºä¿¡æ¯" data-options="left:800,top:54,minimizable:false">
				  <div class="easyui-panel" title="" style="width:440px;">
										<table cellpadding="0" cellspacing="0" border="0" class="datatable table table-striped table-bordered table-hover">
											<thead>
												<tr>
													<th>é£é™©æº</th>
													<th>è¡Œæ”¿åŒºåŸŸ</th>
													<th>æ“ä½œ</th>
												</tr>
											</thead>
											<tbody>
												<tr  th:each="nc : ${riskSources}">
													<td th:text="${nc.riskName}">ä¼ä¸šåç§°</td>
													<td th:text="${nc.company.administrativeDivision.division}">è¡Œæ”¿åŒºåŸŸ</td>								
													<td>
													<a href="#" th:href="@{/riskSourceInfo(riskSourceId=${nc.id})}" target="_blank"><i class="fa  fa-file-text-o"></i><span>è¯¦ç»†</span></a>
													<a th:href="'javascript:theLocation('+${nc.id}+','+${nc.lng} + ',' +${nc.lat} + ');'"><i class="fa  fa-map-marker"></i><span>å®šä½</span></a>
													<a th:href="'javascript:localSearch('+${nc.id}+','+${nc.lng} + ',' +${nc.lat} + ',\'å­¦æ ¡\');'"><i class="fa"></i><span>ğŸ«å­¦æ ¡</span></a>
													<a th:href="'javascript:localSearch('+${nc.id}+','+${nc.lng} + ',' +${nc.lat} + ',\'åŒ»é™¢\');'"><i class="fa"></i><span>ğŸ¥åŒ»é™¢</span></a>
													</td>
												</tr>
									
											</tbody>
											
										</table>
								
								</div>
						
							</div>	  
							
					<!-- 
					 <div id="w1" class="easyui-window" title="å‘¨è¾¹æ•æ„Ÿç‚¹" data-options="left:800,top:200,minimizable:false">	
						 <div class="easyui-panel" title="" style="width:440px;">
										<table id="mingandian" cellpadding="0" cellspacing="0" border="0" class="datatable table table-striped table-bordered table-hover">
											<thead>
												<tr>
													<th>æ•æ„Ÿç‚¹</th>
													<th>åæ ‡</th>
													<th>ç±»å‹</th>
													<th>æ‰‹æœº</th>
												</tr>
											</thead>
											<tbody>
				
											</tbody>
											
										</table>
								
								</div>
						
							</div>
						 -->			
							
			</div>
			<!-- /mainContentBox -->
		
		</div>
		<!-- /maincontent -->
	</section>

    <div th:include="fragments/map-layout :: footerFragment"></div>
	<!--/PAGE -->
	<!-- JAVASCRIPTS -->
	<!-- Placed at the end of the document so the pages load faster -->
	<!-- JQUERY -->
	<div th:include="fragments/map-layout :: jsFragment"></div>
	<script>
		jQuery(document).ready(function() {		
			$('#w').window('collapse');
			App.setPage("mapRiskSource");  //Set current page 
			App.init(); //Initialise plugins and elements
		});
	</script>
	<script th:inline="javascript">
    /*<![CDATA[*/
                        
   function formatData(strVal) {
         if (strVal == '' || strVal == null || strVal == undefined) {
          return '';
          } else {
        return strVal;
       }
    }         
    
   function useDefaultUrl(strVal) {
       if (strVal == '' || strVal == null || strVal == undefined) {
        return 'img/emematerial.jpg';
        } else {
      return strVal;
     }
  } 
    
    
   var map = new BMap.Map("baidumap");
    baiduMaps.init(map);
    addMapOverlay(-1000);//å‘åœ°å›¾æ·»åŠ è¦†ç›–ç‰©
    
	var options = {
			renderOptions: {
				map: map,
				autoViewport: false
			},
			onSearchComplete: function(results) {
			//	alert('æ£€ç´¢å‘¨è¾¹åº”æ€¥ç‰©èµ„å®Œæ¯•');
		/*
				var list= new Array();
				for (var i = 0; i < results.getCurrentNumPois(); i ++){ 
				    list[i]=results.getPoi(i).title + ", " + results.getPoi(i).address;
				    alert(list[i]);
				}
				*/
		   //alert(JSON.stringify(results));
	
			},
			onInfoHtmlSet:function(localResultPoi){
				//   alert(JSON.stringify(localResultPoi));
			}
		};
	var local = new BMap.LocalSearch(map, options);
	
	var drawingManager = new BMapLib.DrawingManager(map, {
		isOpen: false, //æ˜¯å¦å¼€å¯ç»˜åˆ¶æ¨¡å¼
		enableDrawingTool: true, //æ˜¯å¦æ˜¾ç¤ºå·¥å…·æ 
		drawingToolOptions: {
			anchor: BMAP_ANCHOR_TOP_RIGHT, //ä½ç½®
			offset: new BMap.Size(100, 10), //åç¦»å€¼
			scale: 0.5, //å·¥å…·æ ç¼©æ”¾æ¯”ä¾‹
			drawingModes: [
				BMAP_DRAWING_CIRCLE
			]
		}
	});

	drawingManager.addEventListener('circlecomplete', function(e, overlay) {
	    map.clearOverlays();
		//map.addOverlay(overlay);		
		var radius = parseInt(e.getRadius());
		var center = e.getCenter();
		drawingManager.close();
		
		
		//alert('center: ' +center.lng+'  ,lat:' + center.lat +' , radius: ' + radius);
		//local.searchNearby('åº”æ€¥ç‰©èµ„', center, radius, {
		//	customData: {
		//		geotableId:136668
		//	}
		//});
		
// 'geotable_id': 136668,
		  var url = "http://api.map.baidu.com/geosearch/v3/nearby?callback=?";
	        $.getJSON(url, {
	            'geotable_id': 136970,
	            'radius':radius,
	            'page_size':50,
	            'location':''+center.lng+','+center.lat+'',
	             'ak'         : 'ovW97sIaF51o5ADwMGOq4Oza'  //ç”¨æˆ·ak
	        },function(e) {
	            var content = e.contents;
	            map.addOverlay(overlay);	
	            if (content.length == 0) {
	             //   $('#mapList').append($('<p style="border-top:1px solid #DDDDDD;padding-top:10px;text-align:center;text-align:center;font-size:18px;" class="text-warning">æŠ±æ­‰ï¼Œæ²¡æœ‰æ‰¾åˆ°æ‚¨æƒ³è¦çš„çŸ­ç§Ÿä¿¡æ¯ï¼Œè¯·é‡æ–°æŸ¥è¯¢</p>'));
	                alert("é™„ä»¶æ²¡æœ‰æ•æ„Ÿç‚¹");
	             return;
	            }

	        	 $.each(content, function(i, item){
	                 var point = new BMap.Point(item.location[0], item.location[1]);
	                //  marker = new BMap.Marker(point);
	                // alert(item.envclass);
	               var myIcon = new BMap.Icon("img/mingandian/"+item.envclass+".png", new BMap.Size(23, 25), {    
	                	// æŒ‡å®šå®šä½ä½ç½®ã€‚   
	                	// å½“æ ‡æ³¨æ˜¾ç¤ºåœ¨åœ°å›¾ä¸Šæ—¶ï¼Œå…¶æ‰€æŒ‡å‘çš„åœ°ç†ä½ç½®è·ç¦»å›¾æ ‡å·¦ä¸Š    
	                	// è§’å„åç§»10åƒç´ å’Œ25åƒç´ ã€‚æ‚¨å¯ä»¥çœ‹åˆ°åœ¨æœ¬ä¾‹ä¸­è¯¥ä½ç½®å³æ˜¯   
	                	   // å›¾æ ‡ä¸­å¤®ä¸‹ç«¯çš„å°–è§’ä½ç½®ã€‚    
	                	   offset: new BMap.Size(10, 25),    
	                	   // è®¾ç½®å›¾ç‰‡åç§»ã€‚   
	                	   // å½“æ‚¨éœ€è¦ä»ä¸€å¹…è¾ƒå¤§çš„å›¾ç‰‡ä¸­æˆªå–æŸéƒ¨åˆ†ä½œä¸ºæ ‡æ³¨å›¾æ ‡æ—¶ï¼Œæ‚¨   
	                	   // éœ€è¦æŒ‡å®šå¤§å›¾çš„åç§»ä½ç½®ï¼Œæ­¤åšæ³•ä¸css spritesæŠ€æœ¯ç±»ä¼¼ã€‚    
	                	   imageOffset: new BMap.Size(0, 3)   // è®¾ç½®å›¾ç‰‡åç§»    
	                	 });  

	                var marker = new BMap.Marker(point, {icon: myIcon});  
	                marker.addEventListener('click', showInfo);
	                 function showInfo() {
	                     var content = "<img src='" + useDefaultUrl(item.mainimage) + "' style='width:111px;height:133px;float:left;margin-right:5px;'/>" +
	                                   "<p>åç§°ï¼š" + item.title + "</p>" +
	                                   "<p>ç»çº¬åº¦ï¼š" + item.location[0]+"," + item.location[1] + "</p>" +
	                                   "<p>ç¯å¢ƒç±»å‹ï¼š" + item.envtype + "</p>"+
	                                   "<p>æ‰‹æœºï¼š" + formatData(item.emobile) + "</p>";
	                     //åˆ›å»ºæ£€ç´¢ä¿¡æ¯çª—å£å¯¹è±¡
	                     var searchInfoWindow = new BMapLib.SearchInfoWindow(map, content, {
	                         title  : item.title,       //æ ‡é¢˜
	                         width  : 390,             //å®½åº¦
	                         panel  : "panel",         //æ£€ç´¢ç»“æœé¢æ¿
	                         enableAutoPan : true,     //è‡ªåŠ¨å¹³ç§»
	                         searchTypes   :[]
	                     });
	                     searchInfoWindow.open(marker);
	                 };

	             	var label = new BMap.Label(item.title,{offset:new BMap.Size(20,5)});     	
	             	label.setStyle({ 
	             		backgroundColor :"0.05",
	             		border :"0", 
	             		});

	            	marker.setLabel(label);
	            	  map.addOverlay(marker);
	             });
	            
	        });
       
	});
    
    
    
    
    //å®šä½
	function theLocation(sourceId,lng,lat){
		baiduMaps.theLocation(map,sourceId,lng,lat);
	}
    //æœ¬åœ°æŸ¥æ‰¾
	function localSearch(sourceId,lng,lat,s){
		baiduMaps.localSearch(map,sourceId,lng,lat,s);
	}
	
	 function createInfoWindow(marker){
		 var content = '<div  class="panel">'+
							'<div title="" class="ddv panel-body panel-body-noheader panel-body-noborder" style="padding: 2px 0px; width: 100%;">'+
								'<style type="text/css">  .dv-table td{border:1px;text-align:center;padding:2px}.dv-label{font-weight:solid;color:#15428B;}</style>'+
								'<table cellpadding="0" cellspacing="0" border="0" class="datatable table table-striped table-bordered table-hover">'+
									'<tbody>'+
										'<tr>'+
											'<td class="dv-label">ä¼ä¸šåç§°:</td>'+
											'<td>'+marker.riskSourceInfo.companyName+'</td>'+
											'<td class="dv-label">è¡Œæ”¿åŒºåŸŸ:</td>'+
											'<td>'+marker.riskSourceInfo.divsion+'</td>'+
										'</tr>'+
										'<tr>'+
											'<td class="dv-label">é£é™©ç­‰çº§:</td>'+
											'<td>'+marker.riskSourceInfo.lvl+'</td>'+
											'<td class="dv-label">æ˜¯å¦é¢„æ¡ˆ:</td>'+
											'<td>'+marker.riskSourceInfo.riskAversion+'</td>'+
										'</tr>'+
										'<tr>'+
											'<td class="dv-label">åº”æ€¥äººå‘˜</td>'+
											'<td>'+marker.riskSourceInfo.emePersion+'</td>'+
											'<td class="dv-label">åº”æ€¥ç”µè¯</td>'+
											'<td>'+marker.riskSourceInfo.emeTel+'</td>'+
										'</tr>'+
									'</tbody>'+
								'</table><a href="riskSourceInfo?riskSourceId='+marker.riskSourceInfo.id+'"target="_blank">æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://qofo360.com/0web/qzxy/index.html" target="_blank">æŸ¥çœ‹å…¨æ™¯åœ°å›¾</a>'
							'</div>'+
						'</div>';
			var infoWindow = new BMapLib.SearchInfoWindow(map, content, {
				title: marker.title, //æ ‡é¢˜
				offset: new BMap.Size(0,7),
				width: 430,//å®½åº¦
				height: 150, //é«˜åº¦
				panel : "panel", //æ£€ç´¢ç»“æœé¢æ¿
				enableAutoPan : true, //è‡ªåŠ¨å¹³ç§»
				searchTypes :[
				]
			});
		return infoWindow;
	 }
    function addMapOverlay(sourceId){
        $.getRiskSourcesMarkers(function(data){
                       var markers=data;
                         for(var index = 0; index < markers.length; index++ ){
                           var point = new BMap.Point(markers[index].point.lng,markers[index].point.lat);
                         //  var selectedmarker;
                           var marker;
                           if(sourceId==markers[index].riskSourceInfo.id)
                        	 {
                                marker = new BMap.Marker(point,{icon:new BMap.Icon("img/mapimg/waterstation-active.png",new BMap.Size(21,35),{
                                   imageOffset: new BMap.Size(markers[index].imageOffset.width,markers[index].imageOffset.height)
                                 })});
                                var selectedWin=createInfoWindow(markers[index]);
                                selectedWin.open(point);
                        	 }
                           else
                        	   { 
                        	   marker  = new BMap.Marker(point,{icon:new BMap.Icon("img/mapimg/waterstation.png",new BMap.Size(21,35),{
                                   imageOffset: new BMap.Size(markers[index].imageOffset.width,markers[index].imageOffset.height)
                               })});
                        	   
                        	   }
                           
             
                           
                   		  var searchInfoWindow=createInfoWindow(markers[index]);
                   	 	  baiduMaps.addClickHandler(marker,searchInfoWindow);
                          map.addOverlay(marker);

                          //var label = new BMap.Label(markers[index].riskSourceInfo.companyName,{offset:new BMap.Size(20,-10)});
                   	     // marker.setLabel(label);
                         };
         });
         
    	

    }

   /*]]>*/
  </script>
	
	<!-- /JAVASCRIPTS -->
</body>
</html>