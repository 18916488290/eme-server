<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:include="fragments/map-layout :: headFragment">
<!-- <title id="pageTitle">ç©ºæ°”è´¨é‡ç›‘æµ‹ä¸“é¢˜</title>-->
</head>
<body>
	<!-- HEADER -->
	<header class="navbar clearfix navbar-fixed-top" id="header"
		th:include="fragments/map-layout :: headerFragment"> </header>
	<!--/HEADER -->

	<!-- PAGE -->
	<section id="page">
		<!-- SIDEBAR -->
		<div id="sidebar" class="sidebar"
			th:include="fragments/map-layout :: sidebarFragment"></div>
		<!-- /SIDEBAR -->
		<!-- maincontent -->
		<div id="main-content"
			th:include="fragments/map-layout :: main-contentFragment">
			<!-- BREADCRUMBS -->
			<ul class="breadcrumb" id="BREADCRUMBS">
				<li><i class="fa fa-home"></i> <a href="index.html"  th:href="@{/}">ä¸»ç•Œé¢</a></li>
				<li><a href="#"  th:href="@{/mapAir}">ç©ºæ°”è´¨é‡ä¸“é¢˜</a></li>
			</ul>
			<!-- /BREADCRUMBS -->

			<!-- mainContentBox -->
			<div id="mainContentBox">
				   <div class="gmaps" id="baidumap"></div>
				   	  <div id="w" class="easyui-window" title="ç©ºæ°”ç›‘æµ‹ç«™ä¿¡æ¯" data-options="left:800,top:254,minimizable:false">
				         <div class="easyui-panel" title="" style="width:440px;">
										<table cellpadding="0" cellspacing="0" border="0" class="datatable table table-striped table-bordered table-hover">
											<thead>
												<tr>
													<th>ç›‘æµ‹ç«™</th>
													<th>è¡Œæ”¿åŒºåŸŸ</th>
													<th>ç©ºæ°”è´¨é‡</th>
													<th>æ“ä½œ</th>
												</tr>
											</thead>
											<tbody th:each="nc : ${detectStations}">
												<tr>
													<td th:text="${nc.detectStationName}">åç§°</td>
													<td th:text="${nc.administrativeDivision.division}">è¡Œæ”¿åŒºåŸŸ</td>		
													<td style="background-color: #800080; color: white">é‡åº¦æ±¡æŸ“</td>													
													<td>
													<a href="#" th:href="@{/aqiInfo(stationId=${nc.id})}" target="_blank"><i class="fa  fa-file-text-o"></i><span>è¯¦ç»†</span></a>
													<a th:href="'javascript:theLocation('+${nc.id}+','+${nc.lng} + ',' +${nc.lat} + ');'"><i class="fa  fa-map-marker"></i><span>å®šä½</span></a>
													<a th:href="'javascript:localSearch('+${nc.id}+','+${nc.lng} + ',' +${nc.lat} + ',\'å­¦æ ¡\');'"><i class="fa"></i><span>ğŸ«å­¦æ ¡</span></a>
													<a th:href="'javascript:localSearch('+${nc.id}+','+${nc.lng} + ',' +${nc.lat} + ',\'åŒ»é™¢\');'"><i class="fa"></i><span>ğŸ¥åŒ»é™¢</span></a>
													</td>
												</tr>
									
											</tbody>
											
										</table>
								
								</div>
							</div>	 
				  
			</div>
			<!-- /mainContentBox -->
		
		</div>
		<!-- /maincontent -->
	</section>

    <div th:include="fragments/map-layout :: footerFragment"></div>
	<!--/PAGE -->
	<!-- JAVASCRIPTS -->
	<!-- Placed at the end of the document so the pages load faster -->
	<!-- JQUERY -->
	<div th:include="fragments/map-layout :: jsFragment"></div>
	<script>
		jQuery(document).ready(function() {	
			//$('#w').window('collapse');
			App.setPage("mapAir");  //Set current page 
			App.init(); //Initialise plugins and elements
		});
	</script>
	<script th:inline="javascript">
   /*<![CDATA[*/
              
              
         // ç”¨ç»çº¬åº¦è®¾ç½®åœ°å›¾ä¸­å¿ƒç‚¹
	function theLocation(sourceId,lng,lat){
			var new_point = new BMap.Point(lng,lat);
			map.panTo(new_point);   
			map.setZoom(13);
			map.clearOverlays(); 
			addMapOverlay(sourceId);
	}

	// Local search
	function localSearch(sourceId,lng,lat,s){
			var new_point = new BMap.Point(lng,lat);
			map.panTo(new_point);
			map.setZoom(13);
			map.clearOverlays(); 
			addMapOverlay(-1000);
			var circle = new BMap.Circle(new_point,5000,{fillColor:"blue", strokeWeight: 1 ,fillOpacity: 0.3, strokeOpacity: 0.3});
		    map.addOverlay(circle);
		    var local =  new BMap.LocalSearch(map, {renderOptions: {map: map, autoViewport: false}});  
		    local.searchNearby(s,new_point,5000);
	}
               

	var top_left_control = new BMap.ScaleControl({anchor: BMAP_ANCHOR_TOP_LEFT});// å·¦ä¸Šè§’ï¼Œæ·»åŠ æ¯”ä¾‹å°º
	var top_left_navigation = new BMap.NavigationControl();  //å·¦ä¸Šè§’ï¼Œæ·»åŠ é»˜è®¤ç¼©æ”¾å¹³ç§»æ§ä»¶
	var mapType = new BMap.MapTypeControl({mapTypes: [BMAP_NORMAL_MAP,BMAP_HYBRID_MAP]});
	var overView = new BMap.OverviewMapControl();
	var overViewOpen = new BMap.OverviewMapControl({isOpen:true, anchor: BMAP_ANCHOR_BOTTOM_RIGHT});

	function add_control(){
		map.addControl(top_left_control);        
		map.addControl(top_left_navigation);  
		map.addControl(mapType);    
		map.addControl(overView);          //æ·»åŠ é»˜è®¤ç¼©ç•¥åœ°å›¾æ§ä»¶
		map.addControl(overViewOpen);      //å³ä¸‹è§’ï¼Œæ‰“å¼€
	}
              
              
    var map; 
    //åˆ›å»ºå’Œåˆå§‹åŒ–åœ°å›¾å‡½æ•°ï¼š
    function initMap(){
      createMap();//åˆ›å»ºåœ°å›¾
      add_control();
      setMapEvent();//è®¾ç½®åœ°å›¾äº‹ä»¶
      addMapOverlay(-1000);//å‘åœ°å›¾æ·»åŠ è¦†ç›–ç‰©
	 
    }
    function createMap(){ 
      map = new BMap.Map("baidumap"); 
      $.getCenter(function(data){
          map.centerAndZoom(new BMap.Point(data.lng,data.lat),12);
       });
    }
	
    function setMapEvent(){
      map.enableDragging();
 
    }
    function addClickHandler(target,window){
      target.addEventListener("click",function(){
        window.open(target.getPosition());
      });
    }
	
  
	//åˆ›å»ºrichMarkeråœ°å›¾æ ‡æ³¨
	 function addMapOverlay(detectStationId){
		
		   $.getDetectStationMarkers(function(data){
			   var markers =data;
				for (var i = 0; i < markers.length; i++) {
					var marker;
					   var point = new BMap.Point(markers[i].point.lng,
								markers[i].point.lat);
					    if(detectStationId==markers[i].stationId)
                   	 {
                           marker = new BMap.Marker(point,{icon:new BMap.Icon("img/mapimg/waterstation-active.png",new BMap.Size(21,35),{
                              imageOffset: new BMap.Size(markers[i].imageOffset.width,markers[i].imageOffset.height)
                            })});
                           var selectedWin=createInfoWindow(markers[i]);
                           selectedWin.open(point);
                   	 }
					    else
					    	{
							 marker = new BMap.Marker(point,{icon:new BMap.Icon("img/mapimg/waterstation.png",new BMap.Size(21,35),{
					             imageOffset: new BMap.Size(markers[i].imageOffset.width,markers[i].imageOffset.height)
					           })});
					         
					    	}

					var searchInfoWindow=createInfoWindow(markers[i]);
				    addClickHandler(marker,searchInfoWindow);
					map.addOverlay(marker);//æ·»åŠ ä¼ä¸šMarkeræ ‡æ³¨

				}
			   
		   });

		
	 }
	   function addClickHandler(target,window){
		      target.addEventListener("click",function(){
		        window.open(target.getPosition());
		      });
		    }
	

	 function createInfoWindow(marker){
		 var content = '<fieldset> <div  class="panel">'+
							'<div title="" class="ddv panel-body panel-body-noheader panel-body-noborder" style="padding: 2px 0px; width: 100%;">'+
								'<style type="text/css">  .dv-table td{border:1px;text-align:center;padding:2px}.dv-label{font-weight:solid;color:#15428B;}</style>'+
								'<table cellpadding="0" cellspacing="0" border="0" class="datatable table table-striped table-bordered table-hover">'+
									'<tbody>'+					
										'<tr>'+
											'<td class="dv-label">AQI:</td>'+
											'<td>45</td>'+
											'<td class="dv-label">é¦–è¦æ±¡æŸ“ç‰©:</td>'+
											'<td>'+'PM<sub>2.5</sub>'+'</td>'+
										'</tr>'+
										'<tr>'+
											'<td class="dv-label">ç©ºæ°”è´¨é‡çŠ¶å†µ</td>'+
											'<td>'+'è‰¯'+'</td>'+
											'<td class="dv-label">ç©ºæ°”è´¨é‡çº§åˆ«</td>'+
											'<td>'+'II'+'</td>'+
										'</tr>'+
										'<tr>'+
										'<td class="dv-label">äºŒæ°§åŒ–ç¡«(SO<sub>2</sub>)</td>'+
										'<td>'+'39Î¼g/m<sup>3</sup>'+'</td>'+
										'<td class="dv-label">äºŒæ°§åŒ–æ°®(SO<sub>2</sub>)</td>'+
										'<td>'+'58Î¼g/m<sup>3</sup>'+'</td>'+
									'</tr>'+
									'<tr>'+
									'<td class="dv-label">ä¸€æ°§åŒ–ç¢³(CO)</td>'+
									'<td>'+'69mg/m<sup>3</sup>'+'</td>'+
									'<td class="dv-label">è‡­æ°§(O<sub>3</sub>)</td>'+
									'<td>'+'58Î¼g/m<sup>3</sup>'+'</td>'+
								'</tr>'+
								'<tr>'+
								'<td class="dv-label">PM<sub>10</sub></td>'+
								'<td>'+'69Î¼g/m<sup>3</sup>'+'</td>'+
								'<td class="dv-label">PM<sub>2.5</sub></td>'+
								'<td>'+'58Î¼g/m<sup>3</sup>'+'</td>'+
							'</tr>'+
									
									'</tbody>'+
								'</table>'+
								'<a href="aqiInfo?stationId='+marker.stationId+'" target="_blank">æŸ¥çœ‹è¯¦ç»†</a>'+
							'</div>'+
						'</div>'+
						'</fieldset>';
			var infoWindow = new BMapLib.SearchInfoWindow(map, content, {
				title: marker.title, //æ ‡é¢˜
				offset: new BMap.Size(0,7),
				width: 350,//å®½åº¦
				height: 220, //é«˜åº¦
				panel : "panel", //æ£€ç´¢ç»“æœé¢æ¿
				enableAutoPan : true, //è‡ªåŠ¨å¹³ç§»
				searchTypes :[
				]
			});
		return infoWindow;
	 }
	 
	 
	 
	 
	 
	 

	//åˆå§‹åŒ–åœ°å›¾
    initMap();

   /*]]>*/
  </script>
	
	<!-- /JAVASCRIPTS -->
</body>
</html>